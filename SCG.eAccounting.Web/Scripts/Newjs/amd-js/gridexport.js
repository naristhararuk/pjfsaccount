var wijmo;define(["./wijmo.wijgrid","exportUtil","./wijmo.data"],function(){(function(e){(function(t){function a(e){f.exportFile(e)}var n=jQuery;(function(e){e[e.None=0]="None",e[e.Template=1]="Template",e[e.AltTemplate=2]="AltTemplate",e[e.HeaderTemplate=3]="HeaderTemplate",e[e.FooterTemplate=4]="FooterTemplate",e[e.GroupHeaderTemplate=5]="GroupHeaderTemplate",e[e.GroupFooterTemplate=6]="GroupFooterTemplate"})(t.RowTemplateType||(t.RowTemplateType={}));var r=t.RowTemplateType;(function(e){e[e.Header=0]="Header",e[e.Body=1]="Body",e[e.Footer=2]="Footer"})(t.SectionType||(t.SectionType={}));var i=t.SectionType;(function(e){e[e.Data=0]="Data",e[e.Header=1]="Header",e[e.Footer=2]="Footer",e[e.GroupHeader=3]="GroupHeader",e[e.GroupFooter=4]="GroupFooter"})(t.RowType||(t.RowType={}));var s=t.RowType;(function(e){e[e.Text=1]="Text",e[e.Image=2]="Image",e[e.Link=3]="Link",e[e.Checkbox=4]="Checkbox",e[e.Html=5]="Html"})(t.ColType||(t.ColType={}));var o=t.ColType,u=function(){function t(e,t){this.createdGroupHeaderTemplates=[],this.createdGroupFooterTemplates=[];var n=this;n.environmentInfo=t,n._init(e)}return t.prototype._init=function(e){var t=this,r=e.dataView(),i=n(e.element).find(">colgroup>col");t.grid=e,t.showRowHeader=e.options.showRowHeader,t.dataView=r,t.dataCount=r.count();if(t.dataCount>0){var s=r.item(0);t.isArrayData=n.type(s)=="array"}t._initColInfos(i)},t.prototype._initColInfos=function(e){var t=this;t.colLeaves=n.grep(t.grid.columns(),function(e){return e.options._isLeaf}),t.colWidths=[],t.colInfos=e.map(function(e){if(e<0||e>t.colLeaves.length-1)return null;var r=t.colLeaves[e],i=1,s=r.options.dataTypeQualifier;t.isHtmlCol(r)?i=5:t.isLinkCol(r)?i=3:t.isImageCol(r)?i=2:t.isCheckBoxCol(r)&&(i=4),t.colWidths.push(t.computedWidthToPt(n(this).css("width")));var o={formatString:r.options.dataFormatString,dataType:r.options.dataType,type:i};return s&&(o.dataTypeQualifier=s),o}).get()},t.prototype.computedWidthToPt=function(e){return f.pxToPt(e,this.environmentInfo.dpiX)},t.prototype.computedHeightToPt=function(e){return f.pxToPt(e,this.environmentInfo.dpiY)},t.prototype.getDataValue=function(e,t){var n=this;if(e>=n.dataCount||e<0||t<0)return null;var r=n.grid.dataView().item(e);if(n.isArrayData)return n.showRowHeader&&t--,t<0||t>=r.length?null:r[t];var i=n.colLeaves;if(t>=i.length)return null;var s=i[t].options.dataKey;return r[s]},t.prototype.isCheckBoxCol=function(t){return t instanceof e.grid.c1booleanfield},t.prototype.isHtmlCol=function(e){return e.options.cellFormatter!=null},t.prototype.isImageCol=function(e){return!1},t.prototype.isLinkCol=function(t){return t instanceof e.grid.c1buttonfield&&t.options.buttonType==="link"},t}();t.exportContext=u,t.exportGrid=a;var f=function(){function r(){}return r.exportFile=function(e){var n=function(e){return t.exportFile(e,t.toJSON(r._exportSource(e)))},i=r._needNewSingleTable(e),s=r._needRequestAllData(e);if(!i&&!s){n(e);return}var o=r.createGridOptionsForAllData(e,s);r.createGridWithExport(e,o,n)},r.createGridOptionsForAllData=function(t,i){var s=t.grid,o=s.options,u,a=n.extend(!0,{},o,{scrollMode:"none",allowPaging:o.allowPaging,allowVirtualScrolling:!1,selectionMode:"none",scrollingSettings:{mode:"none",freezingMode:"none",staticColumnIndex:-1,staticColumnsAlignment:"left",staticRowIndex:-1,virtualizationSettings:{mode:"none",rowHeight:0,columnWidth:0}}});return i&&(a.pageSize=s.pageCount()*o.pageSize,a.pageIndex=0,u=r._createAllData(t)),e.grid.traverse(a.columns,function(e,t){if(e._dynamic){var r=n.inArray(e,t);r>=0&&t.splice(r,1)}else e.dataKey=e._originalDataKey,e.headerText=e._originalHeaderText}),a.data=u||r._cloneData(t.grid.dataView()),a},r.createGridWithExport=function(e,t,i){t.rendered=r.createGridRendered(e,i),n("<table>").appendTo(n(document.body)).wijgrid(t)},r.createGridRendered=function(e,t,r){return function(){var i=n(this),s=n.extend({},e);s.grid=i.data(e.grid.widgetFullName),t(s),setTimeout(function(){s.grid.destroy(),r=r||i.closest(".wijmo-wijgrid"),i.remove(),r.remove()})}},r._createAllData=function(t){var r=t.grid,i=r.options,s=i.data,o=r.pageCount()*i.pageSize,u;return!s||!e||!e.data||!i.allowPaging||r.pageCount()<=1||t.onlyCurrentPage?null:(u=n.extend(!0,{},s.options||{},{pageIndex:0,pageSize:o}),e.data.ArrayDataView&&s instanceof e.data.ArrayDataView?new e.data.ArrayDataView(n.extend(!0,{},s.getSource()),u):e.data.AjaxDataView&&s instanceof e.data.AjaxDataView?new e.data.AjaxDataView(s.url,u):e.data.ODataView&&s instanceof e.data.ODataView?new e.data.ODataView(s.url,u):e.data.BreezeDataView&&s instanceof e.data.BreezeDataView?new e.data.BreezeDataView(s.query,s.manager,u):null)},r._cloneData=function(e){var t=[],r=e.count(),i;for(i=0;i<r;i++)t.push(n.extend(!0,{},e.item(i)));return t},r._exportSource=function(t){var n=e.exporter.gridExporter._generateEnvironmentInfo(),r={grid:e.exporter.gridExporter._generateTemplate(new u(t.grid,n)),environmentInfo:n,exportFileType:t.exportFileType};return t.fileName&&(r.fileName=t.fileName),t.pdf&&(r.pdf=t.pdf),t.excel&&(r.excel=t.excel),r},r._needRequestAllData=function(e){var t=e.grid,n=t.options,r=n.allowVirtualScrolling,i;if(!r&&n.scrollingSettings&&n.scrollingSettings.virtualizationSettings){i=n.scrollingSettings.virtualizationSettings.mode;if(i==="both"||i==="rows")r=!0}return r&&t.options.totalRows>t.dataView().getSource().length||n.allowPaging&&t.pageCount()>1&&e.onlyCurrentPage===!1},r._needNewSingleTable=function(e){return e.grid.options.scrollMode!=="none"},r.pxToPt=function(t,r){if(t==null)return 0;t=n.trim(t).toLowerCase();var i="px";if(t.indexOf(i,t.length-i.length)==-1)return 0;var s=parseFloat(t);return isNaN(s)?0:s/r*e.exporter.gridExporter.pointPerInch},r._generateEnvironmentInfo=function(){var e=window.location,t=e.protocol+"//"+e.hostname+(e.port&&":"+e.port)+"/",r=n("<div style='height:1in;left:-100%;position: absolute;top:-100%;width:1in;'></div>").appendTo(n(document.body));return{baseUrl:t,dpiX:r.outerWidth(),dpiY:r.outerHeight(),culture:navigator.language?navigator.language:navigator.browserLanguage}},r._generateTemplate=function(t){var r=n(t.grid.element),i=e.exporter.gridExporter._readStyle(t,r),s=e.exporter.gridExporter._readSection(t,r.find(">thead"),0),o=e.exporter.gridExporter._readSection(t,r.find(">tbody"),1),u=e.exporter.gridExporter._readSection(t,r.find(">tfoot"),2),a=r.parent();if(a.hasClass("wijmo-wijgrid")){var f={};n.extend(f,e.exporter.gridExporter._readStyle(t,a),i),i=f}return{colWidths:t.colWidths,style:i,header:s,footer:u,body:o,width:t.computedWidthToPt(r.css("width"))}},r._readSection=function(t,n,r){return t.currentSectionType=r,{colInfos:r===1?t.colInfos:null,style:e.exporter.gridExporter._readStyle(t,n),rows:e.exporter.gridExporter._readRows(t,n),height:t.computedHeightToPt(n.css("height"))}},r._getGroupLevel=function(e){var t=e.attr("aria-level");return t?parseInt(t):0},r._isGroupHeader=function(e){return e.hasClass("wijmo-wijgrid-groupheaderrow")},r._isGroupFooter=function(e){return e.hasClass("wijmo-wijgrid-groupfooterrow")},r._readRows=function(t,i){if(!i||!i.length)return null;var s=-1;return i.find(">tr").map(function(){var i=n(this),o,u,a={height:t.computedHeightToPt(i.css("height"))};return t.currentSectionType===0?(o=1,u=3):t.currentSectionType===2?(o=2,u=4):r._isGroupHeader(i)?(o=3,a.groupLevel=r._getGroupLevel(i),u=t.createdGroupHeaderTemplates[a.groupLevel]?0:5,t.createdGroupHeaderTemplates[a.groupLevel]=!0):r._isGroupFooter(i)?(o=4,a.groupLevel=r._getGroupLevel(i),u=t.createdGroupFooterTemplates[a.groupLevel]?0:6,t.createdGroupFooterTemplates[a.groupLevel]=!0):(++s,o=0,s===0?u=1:s===1?u=2:u=0),t.currentRowType=o,t.currentRowTemplateType=u,o!=0&&(a.type=o),u!=0&&(a.style=e.exporter.gridExporter._readStyle(t,i),a.templateType=u),a.cells=r._readCells(t,i,s),a}).get()},r._readCells=function(t,r,i){return r.find(">th,>td").map(function(r){var s=n(this),o={},u=e.exporter.gridExporter._getSpan(s,"colspan"),a=e.exporter.gridExporter._getSpan(s,"rowspan"),f=e.exporter.gridExporter._cellPos(s).left,l=t.colInfos[f],c=s.find(">.wijmo-wijgrid-innercell");c.length==0&&(c=s),f!=r&&(o.colIndex=f),a!=1&&(o.rowSpan=a),u!=1&&(o.colSpan=u);if(t.currentRowType===0&&i>-1)switch(l.type){case 2:var h=s.find("img");if(h.length!=0){var p={src:h.attr("src"),height:t.computedHeightToPt(h.css("height")),width:t.computedWidthToPt(h.css("width"))};o.value=p}break;case 3:var d=s.find("a");if(d.length!=0){var v={href:d.attr("href"),text:d.text()};o.value=v}break;case 5:o.value=s.html();break;case 1:case 4:o.value=t.getDataValue(i,f),o.text=s.text();break;default:throw"Wrong column type!"}else o.text=s.text();return t.currentRowTemplateType!=0&&(o.style=e.exporter.gridExporter._readStyle(t,s),n.extend(o.style,e.exporter.gridExporter._readFontStyle(t,c))),o}).get()},r._readStyle=function(t,r){var i={backgroundColor:r.css("backgroundColor"),verticalAlign:r.css("verticalAlign")};return n.extend(i,e.exporter.gridExporter._readBorderStyle(t,"Top",r),e.exporter.gridExporter._readBorderStyle(t,"Right",r),e.exporter.gridExporter._readBorderStyle(t,"Bottom",r),e.exporter.gridExporter._readBorderStyle(t,"Left",r)),i},r._readBorderStyle=function(e,t,n){var r={},i="border"+t+"Color",s="border"+t+"Style",o="border"+t+"Width",u=n.css(s);if(u!="none"){var a=e.computedWidthToPt(n.css(o));a!=0&&(r[i]=n.css(i),r[s]=u,r[o]=a)}return r},r._readFontStyle=function(e,t){return{paddingLeft:e.computedHeightToPt(t.css("paddingLeft")),textAlign:t.css("textAlign"),color:t.css("color"),fontFamily:t.css("fontFamily"),fontWeight:t.css("fontWeight"),fontStyle:t.css("fontStyle"),fontSize:e.computedHeightToPt(t.css("fontSize")),textDecoration:t.css("textDecoration")}},r._cellPos=function(t,n){var r=t.data("cellPos");if(!r||n){var i=t.closest("table, thead, tbody, tfoot");e.exporter.gridExporter._scanTable(i)}return r=t.data("cellPos"),r},r._getSpan=function(e,t){var n=e.attr(t);if(n){var r=parseInt(n);if(!isNaN(r))return r}return 1},r._scanTable=function(t){var r=[];t.children("tr").each(function(t,i){n(i).children("td, th").each(function(i,s){var o=n(s),u=e.exporter.gridExporter._getSpan(o,"colspan"),a=e.exporter.gridExporter._getSpan(o,"rowspan"),f,l;u=u?u:1,a=a?a:1;for(;r[t]&&r[t][i];++i);for(f=i;f<i+u;++f)for(l=t;l<t+a;++l)r[l]||(r[l]=[]),r[l][f]=!0;var c={top:t,left:i};o.data("cellPos",c)})})},r.pointPerInch=72,r}();t.gridExporter=f;var l=function(t,r,i,s){var o,u={},a,l;o=r===undefined?"csv":r,o=o.substr(0,1).toUpperCase()+o.substr(1),typeof i=="string"&&arguments.length===3?a=i:(a=s===undefined?"http://demos.componentone.com/ASPNET/ExportService/exportapi/grid":s,u=i);if(!n.isPlainObject(t)){l={fileName:t===undefined?"export":t,serviceUrl:a,grid:this,exportFileType:e.exporter.ExportFileType[o]},l.exportFileType===3&&(l.pdf=u);if(l.exportFileType===0||l.exportFileType===1)l.excel=u}else l=t;f.exportFile(l)};e.grid&&e.grid.wijgrid&&(e.grid.wijgrid.prototype.exportGrid=l),n.wijmo.wijgrid&&(n.wijmo.wijgrid.prototype.exportGrid=l)})(e.exporter||(e.exporter={}));var t=e.exporter})(wijmo||(wijmo={}))});