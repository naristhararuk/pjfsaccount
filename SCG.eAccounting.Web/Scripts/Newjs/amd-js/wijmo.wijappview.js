var wijmo;define(["./wijmo.widget","./wijmo.wijutil"],function(){var e=this.__extends||function(e,t){function r(){this.constructor=e}for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);r.prototype=t.prototype,e.prototype=new r};(function(t){(function(n){function p(){return document.location.hash.match(/^#\w+=/)}var r=jQuery,i="wijappview",s={menu:"menu",content:"content",header:"header",footer:"footer",page:"appviewpage"},o={adjusted:i+"-adjusted"},u="",a=!1;r.fn.findRole=function(e){return this.find(":jqmData(role='"+e+"')")};var f=function(t){function n(){t.apply(this,arguments),this._updatingUrl=!1}return e(n,t),n.prototype._appViewCSS=function(){return this.options.wijCSS.wijappview},n.prototype._initMenu=function(){this._menuDiv=this.element.findRole(s.menu);if(!this._menuDiv.length)throw"A DIV with data-role='"+s.menu+"' not found!";this._linkList=this._menuDiv.find("ul");if(!this._linkList.length)throw"Invalid markup. Link list not found";this._menuDiv.addClass(this._appViewCSS().menu)},n.prototype._initPages=function(e,t){var n=this._pageStore,i=this._appViewCSS();e.each(function(){var e=r(this).addClass(i.page),n=e.attr("id"),s=t;if(e.jqmData("url"))return;n&&(s+="#"+n),e.attr("data-url",s)})},n.prototype._initPageContainer=function(){var e=this._appViewCSS(),t=this._pageStore;this._pageContainer=r("<div/>").addClass(e.pageContainer).prependTo(this.element);var n=this.element.findRole(s.page);this._initPages(n,this._documentUrl),n.each(function(e){t.push(r(this).clone()),e>0&&r(this).remove()}),this._firstPage=n.first().addClass(e.pageActive).appendTo(this._pageContainer),this._initCurrentPage()},n.prototype._getUrl=function(e){var t=e.is("form")?"action":"href",n=e.attr(t);return!n||n==="#"?null:(r.mobile.path.isRelativeUrl(n)&&e.parents(":jqmData(url)").each(function(e,t){var i=r(t).jqmData("url");if(i&&r.mobile.path.isAbsoluteUrl(i))return n=r.mobile.path.makeUrlAbsolute(n,i),!1}),n)},n.prototype._clickLinks=function(e){if(e.isDefaultPrevented()||this._isDisabled())return;var t=this._findClosestLink(e.target);if(!t||r(t).jqmData("appviewpage")===!1)return;var n=this._getUrl(r(t));n&&(e.preventDefault(),e.stopPropagation(),this.changePage(n))},n.prototype._hijackLinks=function(e){var t=this;e.on("click."+i,"a:not(.WijListviewNestedLink), .ui-btn:not(.WijListviewNestedLink)",function(e){t._clickLinks(e)})},n.prototype._submitForms=function(e){if(e.isDefaultPrevented()||this._isDisabled())return;var t=r(e.currentTarget),n=t.closest("."+this._appViewCSS().page);if(!r.mobile.ajaxEnabled||t.is(":jqmData(ajax='false')")||!t.jqmHijackable().length)return;var i=t.attr("method"),s=t.attr("target"),o=this._getUrl(t);if(!o)return;e.preventDefault(),e.stopPropagation(),this.changePage(o,{type:i&&i.length&&i.toLowerCase()||"get",data:t.serialize(),reloadPage:!0})},n.prototype._hijackForms=function(e){var t=this;e.on("submit."+i,"form",function(e){t._submitForms(e)})},n.prototype._initNavigation=function(){var e=this;this._onPopStateScoped=this._onPopStateScoped||r.proxy(this._onPopState,this),r(window).bind("popstate."+i,this._onPopStateScoped),r(window).bind("appviewpagehashchange."+i,function(){return e._navigateToCurrentLocation()}),this._onNavigateScoped=this._onNavigateScoped||r.proxy(this._onNavigate,this),r(r.mobile.pageContainer).bind("navigate."+i,this._onNavigateScoped)},n.prototype._create=function(){this._pageStore=[],this._documentUrl=this._removePageUrlParam(location.href),this.element.attr("data-url",this._documentUrl),this._jqmPageEnclosingWidget=this._findJqmPage(),this.element.addClass(this._appViewCSS().outerDiv),this._initMenu(),this._initPageContainer(),this._hijackLinks(this.element),this._hijackForms(this.element),this._initNavigation(),this._navigateToCurrentLocation(),this._toggleDisable()},n.prototype._toggleDisable=function(){t.prototype._toggleDisable.call(this),this._setInnerElementsDisabledForIE(this._isDisabled())},n.prototype._setInnerElementsDisabledForIE=function(e){if(!r.browser.msie)return;var t=this._appViewCSS(),n=this.element,i=n.offset(),s=this._pageContainer.find("."+t.header),o=this._pageContainer.find("."+t.content),u=n.find("."+t.menu),a=this.options.wijCSS.stateDisabled;s.toggleClass(a,e),o.toggleClass(a,e),u.toggleClass(a,e)},n.prototype.destroy=function(){t.prototype.destroy.call(this);var e="."+i;this.element.unbind(e),r(window).unbind(e),r(r.mobile.pageContainer).unbind(e)},n.prototype._findJqmPage=function(){for(var e=this.element;e.length;e=e.parent()){var t=e.jqmData("mobile-page");if(t)return t}return null},n.prototype._initCurrentPage=function(){var e=this._appViewCSS(),t=this.activePage();t.findRole(s.content).addClass(e.content);var n=t.findRole(s.header).addClass(e.header),r=n.jqmData("position"),i=!r||r==="fixed";i&&n.addClass("ui-header-fixed"),this.element.toggleClass(e.withFixedHeader,i)},n.prototype._findClosestLink=function(e){while(e&&(typeof e.nodeName!="string"||e.nodeName.toLowerCase()!=="a"))e=e.parentNode;return e},n.prototype._clickHandler=function(e){var t=r(e.currentTarget),n=t.is("li")?t.jqmData("url"):t.is("a")?t.attr("href"):null;if(!n)return;e.preventDefault(),e.stopPropagation(),this.changePage(n)},n.prototype._inheritAttribute=function(e,t,n){e.attr(n)&&!t.attr(n)&&t.attr(n,e.attr(n))},n.prototype._findInCache=function(e){return r(r.grep(this._pageStore,function(t){return t.jqmData("url")===e})[0]).clone()},n.prototype.loadPage=function(e,t){var n=this;e=e||"";var i=r.Deferred(),o=r.mobile.path,u=r.extend({},this.options.loadSettings,t),a=!e||e.charAt(0)==="#",f=null,l=null,c=this._makeAbsoluteUrl(e);if(u.data)switch(u.type){case"get":c=o.addSearchParams(c,u.data),u.data=undefined;break;case"post":u.reloadPage=!0}var h=r.Event("pagebeforeload"),p={url:e,absUrl:c,dataUrl:c,deferred:i,options:u};this._trigger(h.type,h,p);if(h.isDefaultPrevented())return i.promise();if(!r.mobile.allowCrossDomainPages&&!o.isSameDomain(o.parseLocation(),c))return i.reject(c,t),i.promise();var d=c&&o.getFilePath(c).replace(/#.+/,""),v=r.ajax({url:d,type:u.type,data:u.data,dataType:"html",success:function(u,a,h){function y(e){return o.isAbsoluteUrl(e)||/^(\w+:|#|\/)/.test(e)?null:o.makeUrlAbsolute(e,d)}var v=r("<div></div>"),m=new RegExp("(<[^>]+\\bdata-"+r.mobile.ns+"role=[\"']?"+s.page+"[\"']?[^>]*>)"),g=new RegExp("\\bdata-"+r.mobile.ns+"url=[\"']?([^\"'>]*)[\"']?");r.browser.msie&&parseFloat(r.browser.version)<=7&&(u=u.replace(/<a[^>]+href=['"][^'"]+['"]/g,function(e){return e.replace(/href=['"]([^'"]+)['"]/,function(e,t){return t=y(t)||t,"href='"+t+"'"})})),v.get(0).innerHTML=u;var b=n._getAllPages(v,e);b.length||(b=r("<div/>").attr("data-role",s.page).html(u.split(/<\/?body[^>]*>/gmi)[1]));var w=u.match(/<title[^>]*>([^<]*)/)&&RegExp.$1;w&&~w.indexOf("&")&&(w=r("<div>"+w+"</div>").text()),b.each(function(e,t){t=r(t),t.attr("data-external-page",!0),!t.jqmData("title")&&w&&t.attr("data-title",w);var n=o.get(d);t.find("[src], [href]").each(function(){var e=r(this).is("[href]")?"href":r(this).is("[src]")?"src":"action",t=y(r(this).attr(e));t&&r(this).attr(e,t)})}),n._initPages(b,d),f=b.filter(function(){return r(this).jqmData("url")===c}),f.length||(f=b.first()),p.xhr=h,p.textStatus=a,p.page=f,p.allPages=b,n._trigger("pageload",null,p),b.each(function(e,t){n._pageStore.push(r(t).clone())}),i.resolve(c,t,f,l)},error:function(e,s,o){p.xhr=e,p.textStatus=s,p.errorThrown=o;var u=r.Event("pageloadfailed");n._trigger(u.type,u,p);if(u.isDefaultPrevented())return;i.reject(c,t)}});return i.fail(function(){v.abort()}),i},n.prototype._getAllPages=function(e,t){return e.findRole(s.page)},n.prototype.activePage=function(){return this._pageContainer.children("."+this._appViewCSS().pageActive).first()},n.prototype.isMenuUrl=function(e){var t=this;return e=e.toLowerCase(),this._menuDiv.find("a").is(function(){var n=t._getUrl(r(this));return n?n.toLowerCase()===e:!1})},n.prototype._showLoading=function(){r.mobile.loading("show")},n.prototype._hideLoading=function(){r.mobile.loading("hide")},n.prototype.changePage=function(e,t){var n=this;t=r.extend({updateUrl:!0},this.options.loadSettings,t);var i={toPage:e,options:t};this._curRequest&&this._curRequest.state()==="pending"&&this._curRequest.rejectWith&&this._curRequest.rejectWith(this,[e,t,!0]);var u,f;if(typeof e=="string"){u=this.activePage().data("url"),f=this._makeAbsoluteUrl(e);var l=f.indexOf("#");if(l>=0&&f.substr(0,l)===u.split("#")[0]){var c=this._findInCache(f);c.length&&(e=c)}}if(typeof e=="string"){this._updateUIBeforeChange(f),t.showLoadMsg&&this._showLoading(),this._curRequest=this.loadPage(e,t).always(function(){t.showLoadMsg&&n._hideLoading(),n._curRequest=null}).done(function(e,t,r,i){n._updateUIAfterChange(r.jqmData("url")),n.changePage(r,t)}).fail(function(e,t,r){r||n._updateUI(u),n._trigger("pagechangefailed",null,i)});return}var h=r.Event("pagebeforechange");this._trigger(h.type,h,i);if(h.isDefaultPrevented())return;var p=e.jqmData("url"),d=null;this._updateUI(p),p&&(d=this._makeRelative(p),d!=null&&(d=this._makeRelative(d)));var v=e.jqmData("title"),m=e.findRole("header"),g=this._appViewCSS();!m.length&&v&&(m=r("<div data-role='header'/>").append(r("<h2/>").text(v)).prependTo(e));if(m.length&&!m.jqmData(o.adjusted)){m.jqmData(o.adjusted,!0);var y=this._firstPage.findRole(s.header);y&&this._inheritAttribute(y,m,"data-position"),this.isMenuUrl(p)&&!m.find("a[data-icon=back]").length&&r("<a/>").attr({href:this._documentUrl,"data-icon":"back"}).text("Back").prependTo(m)}v&&(document.title=v),this._pageContainer.children().removeClass(g.pageActive),e.addClass(g.pageActive).appendTo(this._pageContainer.empty()),this._initCurrentPage();if(t.updateUrl||a)this._updateUrl(p,d,document.title),a=!1;e.jqmData("mobile-page",this._jqmPageEnclosingWidget).jqmData("page",this._jqmPageEnclosingWidget).enhanceWithin().trigger("pagecreate").trigger(this.widgetEventPrefix+"pageinit",i),this._trigger("pagechange",null,i)},n.prototype._updateUIBeforeChange=function(e){var t=this,n=e===this._documentUrl,i=this._linkList.find("li"),s=this._appViewCSS().menuItemActive;if(n)i.removeClass(s);else{var o=i.filter(function(){var n=t._getUrl(r(this).find("a"));return n&&n.toLowerCase()===e.toLowerCase()});o.length&&!o.hasClass(s)&&(i.removeClass(s),o.addClass(s))}},n.prototype._updateUIAfterChange=function(e){var t=this._appViewCSS(),n=e===this._documentUrl;this.element.toggleClass(t.inPage,!n)},n.prototype._updateUI=function(e){this._updateUIBeforeChange(e),this._updateUIAfterChange(e)},n.prototype._changePageIfDifferent=function(e,t){var n=typeof e=="string"?e:e.jqmData("url");this.activePage().jqmData("url")!==n&&this.changePage(e,t)},n.prototype._onNavigate=function(e){var t=new RegExp("^#?"+this.options.urlParamName+"=");(history.state&&history.state.wijappview||document.location.hash.match(t))&&e.preventDefault()},n.prototype._removePageUrlParam=function(e){return e.replace(/\#.*$/,"")},n.prototype._addUrl=function(e){var t=this.options.urlParamName,n=this._removePageUrlParam(location.href);return e&&(n+="#"+t+"="+e),n},n.prototype._makeRelative=function(e){var t=r.mobile.path.parseLocation(),n=e;if(e){var i=t.domain+t.directory;e.substr(0,t.hrefNoHash.length)===t.hrefNoHash?n=e.substr(t.hrefNoHash.length):e.substr(0,i.length)===i&&(n=e.substr(i.length))}return n},n.prototype._makeAbsoluteUrl=function(e){var t=r.mobile.path,n=this.activePage(),i=t.makeUrlAbsolute(n.jqmData("url")||this._documentUrl,this._documentUrl);return!i.match(/\/$/)&&!i.match(/\./)&&(i+="/"),e&&t.makeUrlAbsolute(e,i)},n.prototype._onPopState=function(e){if(this._updatingUrl)return;history.state&&history.state.wijappview?this._changePageIfDifferent(history.state.absUrl||this._firstPage,{updateUrl:!1}):this._navigateToCurrentLocation()},n.prototype._navigateToCurrentLocation=function(){var e=new RegExp("#"+this.options.urlParamName+"=(.+)"),t=e.exec(location.href)||u&&e.exec(u),n=t?r.mobile.path.makeUrlAbsolute(t[1],this._documentUrl):this._firstPage;u="",this._changePageIfDifferent(n,{updateUrl:!1})},n.prototype._updateUrl=function(e,t,n){this._updatingUrl=!0;try{r.mobile.navigate.navigator.preventHashAssignPopState=!0,document.location.hash=e===this._documentUrl?"":this.options.urlParamName+"="+t}finally{this._updatingUrl=!1}},n}(t.wijmoWidget);n.wijappview=f;var l="wijmo-wijappview",c=l+"-",h=function(){function e(){this.urlParamName="appviewpage",this.loadSettings={type:"GET",data:undefined,reloadPage:!1,showLoadMsg:!1},this.pagebeforeload=null,this.pageload=null,this.pageloadfailed=null,this.pagebeforechange=null,this.pagechange=null,this.pagechangefailed=null,this.wijCSS={wijappview:{outerDiv:l,inPage:c+"in-page",menu:c+"menu",menuItemActive:"ui-btn-down-b",page:c+"page",pageActive:c+"page-active",pageContainer:c+"page-container",content:c+"content",header:c+"header",withFixedHeader:c+"with-fixed-header"}}}return e}();n.wijappview_options=h,f.prototype.options=r.extend({},t.wijmoWidget.prototype.options,new h),r.mobile&&(r.wijmo.registerWidget(i,f.prototype),r(window).bind("hashchange",function(e){p()&&(e.stopImmediatePropagation(),r(window).trigger("appviewpagehashchange"))}),p()&&(u=document.location.hash,r(window).bind("pagecontainercreate",function(){document.location.hash="",a=!0})))})(t.appview||(t.appview={}));var n=t.appview})(wijmo||(wijmo={}))});