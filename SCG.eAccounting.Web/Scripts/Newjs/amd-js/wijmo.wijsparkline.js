var wijmo;define(["./wijmo.widget","./wijmo.wijutil","./wijmo.raphael"],function(){var e=this.__extends||function(e,t){function r(){this.constructor=e}for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n]);r.prototype=t.prototype,e.prototype=new r};(function(t){(function(n){var r=jQuery,i="wijsparkline",s={line:{stroke:"#5b8f00","stroke-width":1,opacity:.9},area:{stroke:"#009999","stroke-width":1,fill:"#0099ff","fill-opacity":.5},column:{stroke:"none",fill:"#0099ff","fill-opacity":.9,negStyle:{fill:"#ff0000"},zeroStyle:{fill:"#808080"}}},o=function(){function e(e){this._hOffset=15,this._vOffset=-15,this._tooltipEle=r("<div style='position:absolute' class='wijmo-wijsparkline-tooltip'></div>"),this._tooltipEle.appendTo("body").hide()}return e.prototype.show=function(e,t){this._tooltipEle.css({left:t.originalLeft+this._hOffset,top:t.originalTop+this._vOffset}).empty().append(e),this._tooltipEle.is(":hidden")&&this._tooltipEle.show()},e.prototype.hide=function(){this._tooltipEle.hide()},e.prototype.destroy=function(){this._tooltipEle.remove(),this._tooltipEle=null},e}();n.SparklineTooltip=o;var u=function(n){function u(){n.apply(this,arguments)}return e(u,n),u.prototype._create=function(){var e=this,t=e.options,i=t.width||e.element.width(),s=t.height||e.element.height(),o=e.element.attr("style"),u,a;e.wrapper=r("<div class='ui-widget "+t.wijCSS.sparkline+"'></div>").attr("style",o||""),i&&e.wrapper.css("width",i),s&&e.wrapper.css("height",s),e.canvasWrapper=r("<div class='"+t.wijCSS.canvasWrapper+"'></div>"),e.element.wrap(e.wrapper).after(e.canvasWrapper).hide();if(e.canvasWrapper.is(":hidden")&&e.canvasWrapper.wijAddVisibilityObserver){if(e.canvasWrapper.hasClass("wijmo-wijobserver-visibility"))return;e.canvasWrapper.wijAddVisibilityObserver(function(){e.redraw(),e.canvasWrapper.wijRemoveVisibilityObserver&&e.canvasWrapper.wijRemoveVisibilityObserver()},"wijsparkline")}t.data?e.data=t.data:(a=e.element.html(),e.data=a.replace(/(^\s*<!--)|(-->\s*$)|\s+/g,"").split(",")),u=Raphael(e.canvasWrapper[0],i,s),e.canvas=u,e.canvasWrapper.is(":visible")&&e._render(),n.prototype._create.call(this)},u.prototype._setOption=function(e,t){var r=this.options;e==="height"||e==="width"?(r[e]=t,this.element[e](t)):e==="data"?this.data=r.data=t:n.prototype._setOption.call(this,e,t),this.redraw()},u.prototype._innerDisable=function(){n.prototype._innerDisable.call(this),this._toggleDisableSparkline(!0)},u.prototype._innerEnable=function(){n.prototype._innerEnable.call(this),this._toggleDisableSparkline(!1)},u.prototype._toggleDisableSparkline=function(e){this.element.parent().toggleClass(this.options.wijCSS.stateDisabled,e)},u.prototype._render=function(){var e=this,t=e.options,n=t.type,i=t.seriesList,s=t.seriesStyles?t.seriesStyles.length:0,o;e.seriesRegionInfos=[],e.canvas.clear(),e.canvasBounds={startX:0,width:t.width||this.element.width()||this.canvasWrapper.width(),startY:0,height:t.height||this.element.height()||this.canvasWrapper.height()},n=n&&n!==""?n.toLowerCase():"line",e.containsColumnType=n==="column"||r.grep(i,function(e){return e.type&&e.type.toLowerCase()==="column"}).length>0,i&&i.length>0?r.each(i,function(r,i){var u=i.type&&i.type!==""?i.type.toLowerCase():n;o=s>0?t.seriesStyles[r%s]:null,e._internalRender(i,t,u,o)}):(o=s>0?t.seriesStyles[0]:null,e._internalRender(null,t,n,o)),e._bindCanvasEvents()},u.prototype._internalRender=function(e,n,i,o){var u,a,f,l,c=s[i];o=r.extend({},c,o,e?e.seriesStyle:null),f=e&&e.data?e.data:this.data,e&&e.columnWidth!==undefined&&e.columnWidth!==null&&typeof e.columnWidth=="number"?l=e.columnWidth:l=n.columnWidth,u=new t.sparkline[i+"Render"](this.element,this.canvas,i,{data:f,min:n.min,max:n.max,valueAxis:n.valueAxis,origin:n.origin,animation:n.animation,bind:e?e.bind||n.bind:n.bind,seriesStyle:o,columnWidth:l,canvasBounds:this.canvasBounds});if(!u.isValid())return!0;u.render(),a={type:i,bind:e?e.bind:null,regionInfos:u.getRegionInfos()},i==="column"&&(this.colunmWidth=u.getColumnWidth()),this.seriesRegionInfos.push(a)},u.prototype.redraw=function(){var e=this.options,t=0,n=0;t=e.width||this.element.width()||this.canvasWrapper.width(),n=e.height||this.element.height()||this.canvasWrapper.height();if(t<1||n<1)return;this.canvas.setSize(t,n),this._render()},u.prototype.destroy=function(){this._unbindCanvasEvents(),this.element.unwrap().show(),this.canvas.clear(),this.wrapper=null,this.canvasWrapper.remove(),this.canvasWrapper=null,this.seriesRegionInfos=[],this.canvasBounds=null,this.tooltip&&(this.tooltip.destroy(),this.tooltip=null),n.prototype.destroy.call(this)},u.prototype._bindCanvasEvents=function(){var e=this,t=e.options,n=e.canvasWrapper,s="",o="."+i;if(!n||!e.canvas)return;r.support.isTouchEnabled&&r.support.isTouchEnabled()&&(window.navigator.pointerEnabled?this.element.css("touch-action","none"):window.navigator.msPointerEnabled&&this.element.css("-ms-touch-action","none")),r.support.isTouchEnabled&&r.support.isTouchEnabled()&&(s="wij"),n.bind(s+"mousemove"+o,function(t){var r=e._getMousePosition(n,t),i=e._isDisabled();if(i)return;e._mouseMoveInsideArea(r)}),n.bind(s+"mouseout"+o,function(t){var n=t.currentTarget,r=t.relatedTarget?t.relatedTarget:t.toElement,i=e._isDisabled();if(i)return;if(n.nodeName.toLowerCase()!=="div")return;while(r&&r!==n&&r.nodeName.toLowerCase()!=="body")r=r.parentNode;if(r===n)return;e._mouseOutInsideArea()}),n.bind(s+"click"+o,function(t){var r=e._getMousePosition(n,t),i=e._isDisabled(),s=[];if(i)return;s=e._getCurrentRegionInfos(r),e._trigger("click",null,{currentRegion:s})})},u.prototype._getMousePosition=function(e,t){var n=e.offset(),r=document.compatMode==="CSS1Compat",i=r?t.pageX:t.clientX,s=r?t.pageY:t.clientY,o={left:i-n.left,originalLeft:i,top:s-n.top,originalTop:s};return o},u.prototype._mouseMoveInsideArea=function(e){var t=this,n=t.options,i=n.tooltipFormat,s=n.tooltipContent,o="",u=[],a=NaN;u=t._getCurrentRegionInfos(e),u.length>0&&(r.each(u,function(e,n){var f;e===0&&(o+="<span>"),s&&r.isFunction(s)?f=r.proxy(s,t.data[n.index])():(n.bind&&(o+=n.bind+": "),i?f=i.replace(/\{(\d+)\}/g,n.value.toString()):f=n.value.toString()),o+=f,e<u.length-1?o+="<br />":o+="</span>";if(isNaN(a))if(t.containsColumnType)n.type==="column"&&(a=n.position.x+t.colunmWidth/2);else if(n.type==="line"||n.type==="area")a=n.position.x}),this._paintTooltip(o,e),this._paintIndicatorLine(a)),this._trigger("mouseMove",null,{currentRegion:u})},u.prototype._mouseOutInsideArea=function(){this.tooltip&&this.tooltip.hide(),this.indicatorLine&&(this.indicatorLine.wijRemove(),this.indicatorLine=null)},u.prototype._getCurrentRegionInfos=function(e){var t=this,n=[];return r.each(this.seriesRegionInfos,function(r,i){var s,o="_"+i.type+"GetCurrentRegionInfo",u=t[o];u&&(s=u.call(t,i,e),s&&(s.type=i.type,s.bind=i.bind,n.push(s)))}),n},u.prototype._lineGetCurrentRegionInfo=function(e,t){var n=e.regionInfos,i,s;if(!n)return;return i=n.length,r.each(n,function(e,r){var o=r.position,u,a;if(e<i-1){u=n[e+1],a=u.position;if(t.left>=o.x&&t.left<a.x)return s=r,s.index=e,!1}else if(t.left>=o.x)return s=r,s.index=e,!1}),s},u.prototype._areaGetCurrentRegionInfo=function(e,t){return this._lineGetCurrentRegionInfo(e,t)},u.prototype._columnGetCurrentRegionInfo=function(e,t){return this._lineGetCurrentRegionInfo(e,t)},u.prototype._pieGetCurrentRegionInfo=function(e,t){return null},u.prototype._bulletGetCurrentRegionInfo=function(e,t){return null},u.prototype._unbindCanvasEvents=function(){r.support.isTouchEnabled&&r.support.isTouchEnabled()&&(window.navigator.pointerEnabled?this.element.css("touch-action",""):window.navigator.msPointerEnabled&&this.element.css("-ms-touch-action","")),this.element.unbind("."+i)},u.prototype._paintTooltip=function(e,t){this.tooltip||(this.tooltip=new o(this.options.tooltipStyle)),this.tooltip.show(e,t)},u.prototype._paintIndicatorLine=function(e){var t,n,r,i;this.indicatorLine?this.indicatorLine.transform("T"+e+" 0"):(t=this.canvasBounds.height,n=this.canvasBounds.startX,r=this.canvasBounds.startY,i=["M",n,r,"V",t],this.indicatorLine=this.canvas.path(i.join(" ")),this.indicatorLine.transform("T"+e+" 0"))},u}(t.wijmoWidget);n.wijsparkline=u;var a=function(){function e(e,t,n,r){this.isValidData=!0,this.values=[],this.type=n,this.options=r,this.element=e,this.canvas=t,this.animationSet=t.set(),this.scanValues(),this.options.min===null||this.options.min===undefined||typeof this.options.min!="number"?this.minValue=Math.min.apply(Math,this.values):this.minValue=this.options.min,this.options.max===null||this.options.max===undefined||typeof this.options.max!="number"?this.maxValue=Math.max.apply(Math,this.values):this.maxValue=this.options.max}return e.prototype.render=function(){if(!this.element||!this.canvas)return},e.prototype.playAnimation=function(){var e=this.options,t=e.canvasBounds,n=e.animation;this.animationSet.length>0&&n&&n.enabled&&(this.animationSet.wijAttr("clip-rect",Raphael.format("{0} {1} 0 {2}",t.startX,t.startY,t.height)),this.animationSet.wijAnimate({"clip-rect":Raphael.format("{0} {1} {2} {3}",t.startX,t.startY,t.width,t.height)},n.duration,n.easing,null))},e.prototype.scanValues=function(){var e=this,t=e.options,n=t.bind,i=t.data;r.isArray(i)&&r.each(i,function(t,r){var i;n&&r&&r[n]!==undefined?i=r[n]:i=r,typeof i=="string"&&(i=parseFloat(i));if(isNaN(i))return e.isValidData=!1,!1;e.values.push(i)})},e.prototype.setRegionInfos=function(){var e=this,t=0,n=e.options.canvasBounds.height,i=e.options.canvasBounds.width,s;if(!e.values||e.values.length===0)return;this.regionInfos||(this.regionInfos=[]),s=e.values.length,t=e.maxValue-e.minValue,e.valRange=t=t===0?1:t,r.each(e.values,function(r,o){var u,a;u=r*(i/s),a=n*(1-(o-e.minValue)/t),e.regionInfos.push({value:o,position:{x:u,y:a}})})},e.prototype.getRegionInfos=function(){return(!this.regionInfos||this.regionInfos.length===0)&&this.setRegionInfos(),this.regionInfos},e.prototype.getColumnWidth=function(){return null},e.prototype.isValid=function(){return this.isValidData},e}();n.sparklineRenderBase=a;var f=function(t){function n(e,n,r,i){t.call(this,e,n,r,i),this.regionInfos=[]}return e(n,t),n.prototype.render=function(){var e=this.options,n=[];t.prototype.render.call(this),this.setRegionInfos(),this.regionInfos&&this.regionInfos.length>0&&(r.each(this.regionInfos,function(e,t){var r=t.position;e===0?n.push("M"):n.push("L"),n.push(r.x),n.push(r.y)}),n.length>0&&(this.line=this.canvas.path(n.join(" ")),this.line.wijAttr(e.seriesStyle),this.line.wijAttr("fill","none"),this.animationSet.push(this.line),this.type==="line"&&this.playAnimation()))},n}(a);n.lineRender=f;var l=function(t){function n(e,n,r,i){t.call(this,e,n,r,i)}return e(n,t),n.prototype.render=function(){var e=this.options.canvasBounds.height,n=this.maxValue,i=this.minValue,s=this.options.origin,o,u,a,f;t.prototype.render.call(this);if(this.options.valueAxis){if(s===null||s===undefined||typeof s!="number")s=(n-i)/2+i;u=e*(1-(s-this.minValue)/this.valRange)}else u=e;a=Raphael.parsePathString(this.line.attr("path")),a&&a.length>0&&(f=[],r.each(a,function(e,t){r.each(t,function(e,t){f.push(t)}),t[0]==="M"&&(o=t[1]),e===a.length-1&&(f.push("V"),f.push(u),f.push("H"),f.push(o),f.push("Z"))})),f.length>0&&(this.area=this.canvas.path(f.join(" ")),this.area.wijAttr(this.options.seriesStyle),this.area.wijAttr("stroke","none"),this.animationSet.push(this.area),this.playAnimation())},n}(f);n.areaRender=l;var c=function(t){function n(e,n,r,i){t.call(this,e,n,r,i),this.animateBars=[]}return e(n,t),n.prototype.render=function(){var e=this,n=this,i=n.maxValue,s=n.minValue,o=n.canvas,u=n.options,a=u.origin,f=u.animation,l=u.canvasBounds.height,c=u.seriesStyle,h=u.seriesStyle.negStyle,p=u.seriesStyle.zeroStyle,d,v,m;t.prototype.render.call(this),n.setRegionInfos(),delete c.zeroStyle,delete c.negStyle,h=r.extend({},c,h),p=r.extend({},c,p),this.columnWidth=n.adjustColumnWidth(),d=l/n.valRange,v=f&&f.enabled;if(u.valueAxis){if(a===null||a===undefined||typeof a!="number")a=(i-s)/2+s;m=(i-a)*d}else m=l;n.regionInfos&&n.regionInfos.length>0&&(r.each(n.regionInfos,function(t,r){var i,f,g,y,b,w,E=r.position.x,S=r.value;u.valueAxis?S>=a?(w=S===a,b=w?r.position.y-2*d:r.position.y,i=v?m:r.position.y,f=w?2*d:(S-a)*d,g=w?p:c):(b=i=m,f=(a-S)*d,g=h):(w=S===s,b=w?r.position.y-2*d:r.position.y,i=m,f=w?2*d:l-r.position.y,g=w?p:c),y=o.rect(E,i,e.columnWidth,f),y.wijAttr(g),y.top=b,y.height=f,n.animateBars.push(y)}),n.playAnimation())},n.prototype.playAnimation=function(){var e=this.options,t=e.animation;t&&t.enabled?this.animateBars.length>0&&r.each(this.animateBars,function(e,n){var r={height:n.height,y:n.top};n.wijAttr({height:0}),n.stop().wijAnimate(r,t.duration,t.easing,null)}):this.animateBars.length>0&&r.each(this.animateBars,function(e,t){var n={height:t.height,y:t.top};t.wijAttr(n)})},n.prototype.adjustColumnWidth=function(){var e=this.options,t=e.columnWidth,n=e.canvasBounds.width,r=2,i;return i=n/this.values.length-r,t>i?i:t},n.prototype.getColumnWidth=function(){return this.columnWidth},n}(a);n.columnRender=c;var h=function(){function e(){this.initSelector=":jqmData(role='wijsparkline')",this.wijCSS={sparkline:"wijmo-wijsparkline",canvasWrapper:"wijmo-sparkline-canvas-wrapper"},this.type="line",this.seriesList=[],this.width=null,this.height=null,this.data=null,this.bind=null,this.seriesStyles=[],this.animation={enabled:!0,duration:2e3,easing:"easeInCubic"},this.valueAxis=!1,this.origin=null,this.min=null,this.max=null,this.columnWidth=10,this.tooltipFormat=null,this.tooltipContent=null,this.mouseMove=null,this.click=null,this.disabled=!1}return e}();u.prototype.options=r.extend(!0,{},u.prototype.options,new h),u.prototype.widgetEventPrefix="wijsparkline",r.wijmo.registerWidget("wijsparkline",u.prototype)})(t.sparkline||(t.sparkline={}));var n=t.sparkline})(wijmo||(wijmo={}))});